<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
	<script src="crypto-js.min.js"></script>
	<script src="emoji-browser.js"></script>
    <script src="translations.js"></script>
	<script src="quotes.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="security.js"></script>
	<script src="ui.js"></script>
	<script src="socket-logic.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
	<link rel="icon" type="image/png" href="/img/logo.png">
	<link rel="apple-touch-icon" href="/img/logo.png">
</head>

<body>
	<div id="welcome-screen">
		<div style="position: fixed; bottom: 10px; width: 100%; text-align: center; pointer-events: none;">
			<span style="background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 10px; color: #bbb; font-size: 9px; letter-spacing: 1px;">
				RELEASE 1.5.0
			</span>
		</div>
		<div class="lang-selector-home">
			<select id="lang-select-home" onchange="applyLanguage(this.value)">
				<option value="fr">FranÃ§ais ðŸ‡«ðŸ‡·</option>
				<option value="en">English ðŸ‡¬ðŸ‡§</option>
				<option value="zh">ä¸­æ–‡ ðŸ‡¨ðŸ‡³</option>
			</select>
		</div>

		<div class="welcome-card">
			<h1 id="txt-welcome-title">Bienvenue</h1>
			
			<div id="daily-quote-container">
				<span id="quote-intro" style="font-weight: bold; font-size: 0.9em; color: #3498db;"></span>
				<p id="quote-text">--</p>
			</div>

			<button id="enter-chat-btn" onclick="startSecurityProcess()">AccÃ©der au Chat SÃ©curisÃ©</button>
		</div>
	</div>
    <div id="chat-container">
        <div id="chat-header">
            <div style="font-weight: bold;" id="txt-header-title"></div>

			<div id="clocks-container">
				<div class="clock-unit">
					<div class="analog-clock" id="them-analog">
						<div class="hand hour"></div>
						<div class="hand minute"></div>
						<div class="center-dot"></div>
					</div>
					<div id="them-city-name">--</div>
				</div>
				<div class="clock-unit">
					<div class="analog-clock" id="me-analog">
						<div class="hand hour"></div>
						<div class="hand minute"></div>
						<div class="center-dot"></div>
					</div>
					<div id="me-city-name">--</div>
				</div>
			</div>
			
            <div class="header-right">
                <a href="/cgu" target="_blank" id="txt-view-cgu"></a>
                <button id="theme-toggle" style="cursor:pointer; border:none; background:none; font-size: 1.2rem;">ðŸŒ™</button>
                <select id="lang-select" style="cursor: pointer; margin: 5px;">
                    <option value="fr">FranÃ§ais ðŸ‡«ðŸ‡·</option>
                    <option value="en">English ðŸ‡¬ðŸ‡§</option>
                    <option value="zh">ä¸­æ–‡ ðŸ‡¨ðŸ‡³</option>
                </select>
            </div>
			
        </div>
		<div id="chat-wrapper">
			<button id="load-more-btn" style="background:none; border:none; cursor:pointer; display:none;">
				Charger les messages prÃ©cÃ©dents...
			</button>
		</div>
        <ul id="messages"></ul>
        <div id="typing-indicator"></div>
		<footer id ="chat-footer">
			<form id="form">
				<label for="file-input" style="cursor:pointer; font-size: 1.5em; padding: 5px; margin: 5px;">ðŸ“Ž</label>
				<button type="button" id="emoji-btn">ðŸ˜€</button>
				<button type="button" id="voice-btn">ðŸŽ¤</button>
				<div id="recording-status" style="display:none; color:red; font-size:0.8em; margin: 5px;">
					... <span id="timer">0s</span>
				</div>
				<input type="file" id="file-input" accept="image/*" style="display:none;">
				<textarea id="input" placeholder="Ã‰crivez un message..." rows="1"></textarea>
				<button id="send-btn" type="submit">Envoyer</button>
			</form>
		</footer>
    </div>

    <script>
        var socket = io({
			transports: ['polling', 'websocket'],
			upgrade: true
		});
        var chatContainer = document.getElementById('chat-container');
        var messages = document.getElementById('messages');
        var form = document.getElementById('form');
        var input = document.getElementById('input');
        var typingIndicator = document.getElementById('typing-indicator');
        var SECRET_KEY = "";
        var myPseudo = "";
        var typingTimeout;        
				
		// Capture les erreurs JavaScript globales
		window.onerror = function(message, source, lineno, colno, error) {
			var errorData = {
				message: message,
				source: source,
				line: lineno,
				pseudo: typeof myPseudo !== 'undefined' ? myPseudo : 'Inconnu'
			};
			// Envoie l'erreur au serveur via le socket
			if (typeof socket !== 'undefined') {
				socket.emit('client error', errorData);
			}
			alert(errorData);
		};
		
        //socket.emit('client error', { message: "DEBUG: Script HTML chargÃ©", pseudo: myPseudo });
		// Dans ton Ã©vÃ©nement de clic pour rejoindre le chat :
		document.getElementById('enter-chat-btn').addEventListener('click', () => {
			// On crÃ©e un contexte audio ou on joue un son bref pour "dÃ©verrouiller"
			const audio = new Audio('/sounds/pop.mp3');
			audio.muted = true; // On peut le mettre en muet pour le dÃ©verrouillage
			audio.play().then(() => {
				console.log("Audio dÃ©bloquÃ© pour cette session !");
			}).catch(e => console.log("DÃ©verrouillage Ã©chouÃ©"));
			// Ã€ mettre dans ton bouton "Envoyer" ou "Rejoindre"
			requestNotificationPermission();
		});
    	// Initialisation au chargement
    	document.addEventListener('DOMContentLoaded', () => {
    		var selector = document.getElementById('lang-select');
    		if (selector) {
    			var savedLang = localStorage.getItem('preferred-lang') || 'fr';
    			selector.value = savedLang;
    			applyLanguage(savedLang);
    
    			selector.addEventListener('change', (e) => {
    				applyLanguage(e.target.value);
    			});
    		} else {
    			console.error("Le sÃ©lecteur 'lang-selector' est introuvable !");
    		}
    	});
    
        // FONCTION D'AFFICHAGE DES MESSAGES ---
		function addMessage(data, side, isPrepend = false) {
			var item = document.createElement('li');
			item.classList.add('message', side);
			
			let displayText = "";
			let displayImage = null;
			let displayAudio = null;

			// --- LOGIQUE DE DÃ‰CHIFFREMENT (Ton code inchangÃ©) ---
			if (data.isEncrypted && SECRET_KEY) {
				try {
					if (data.text && data.text.length > 0) {
						var textBytes = CryptoJS.AES.decrypt(data.text, SECRET_KEY);
						var decryptedText = textBytes.toString(CryptoJS.enc.Utf8);
						displayText = decryptedText || "[Erreur de clÃ©]";
					}
					if (data.image) {
						if (data.image.startsWith('data:image')) {
							displayImage = data.image;
						} else {
							var imgBytes = CryptoJS.AES.decrypt(data.image, SECRET_KEY);
							var decryptedImg = imgBytes.toString(CryptoJS.enc.Utf8);
							displayImage = decryptedImg || null;
							if (!displayImage) displayText = "[ClÃ© image incorrecte]";
						}
					}
					if (data.type === 'voice' && data.audio) {
						try {
							let rawBase64 = "";
							if (data.audio.startsWith('data:audio')) {
								rawBase64 = data.audio;
							} else {
								var audioBytes = CryptoJS.AES.decrypt(data.audio, SECRET_KEY);
								rawBase64 = audioBytes.toString(CryptoJS.enc.Latin1);
							}

							const blob = dataURLtoBlob(rawBase64);
							if (blob) {
								displayAudio = URL.createObjectURL(blob);
							}
						} catch (e) {
							console.error("Erreur technique audio:", e);
						}
					}
				} catch (e) { 
					console.error("Erreur de dÃ©chiffrement :", e);
					displayText = "[Message illisible]"; 
				}
			} else {
				displayText = data.text || "";
				displayImage = data.image || null;
				displayAudio = data.audio || null;
			}

			// --- LOGIQUE D'AFFICHAGE (Ton code inchangÃ©) ---
			var color = getHashColor(data.pseudo || "Anonyme");
			var nameStyle = (side === 'me') ? 'display:none' : `color:${color}; font-weight:bold; font-size:0.8em; margin-bottom:3px;`;
			var imageHtml = displayImage ? `<img src="${displayImage}" style="max-width:100%; border-radius:10px; margin:5px; display:block;">` : "";
			var audioHtml = displayAudio ? `
				<audio controls 
					   preload="metadata" 
					   src="${displayAudio}" 
					   onplay="console.log('Lecture en cours...')" 
					   style="max-width: 100%; margin: 5px; height: 35px;">
				</audio>` : "";
			var tickContent = (data.read) ? 'âœ“âœ“' : 'âœ“';
			var tickColor = (data.read) ? 'color: #3498db;' : '';
			var statusCheckHtml = (side === 'me') ? `<span class="status-check" id="tick-${data.id || Date.now()}" style="${tickColor}">${tickContent}</span>` : "";

			item.innerHTML = `
				<div style="${nameStyle}">${data.pseudo || 'Anonyme'}</div>
				<div class="message-wrapper">
					<div>${displayText}</div>
					${imageHtml}
					${audioHtml}
				</div>
				<div class="message-footer" style="display: flex; align-items: center; justify-content: flex-end; margin-top:3px">
					<span class="time">${data.time || ''}</span>
					${statusCheckHtml}
				</div>
			`;

			// --- LOGIQUE D'INSERTION (C'est ici que Ã§a change) ---
			var messagesList = document.getElementById('messages');

			if (isPrepend) {
				// On insÃ¨re tout en haut de la liste <ul>
				messagesList.prepend(item); 
			} else {
				// On ajoute en bas normalement
				messagesList.appendChild(item);
				messagesList.scrollTop = messagesList.scrollHeight;
			}
		}
    
        // ENVOI DE TEXTE ---
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          if (input.value.trim()) {
            var timeStr = getNowFormatted(); // Utilisation du nouveau format
            
            var encryptedText = CryptoJS.AES.encrypt(input.value, SECRET_KEY).toString();
            var data = { text: encryptedText, time: timeStr, pseudo: myPseudo, isEncrypted: true, id: 'msg-' + Date.now() };
            
            addMessage(data, 'me');
            socket.emit('chat message', data);
            input.value = '';
            input.style.height = 'auto';
            socket.emit('stop typing');
          }
        });
    
        // IHM : ENTRÃ‰E ET AGRANDISSEMENT AUTO ---
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            form.dispatchEvent(new Event('submit'));
          }
        });
    
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            socket.emit('typing', myPseudo);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => socket.emit('stop typing'), 5000);
        });
    
        // ENVOI DE PHOTOS CHIFFRÃ‰ES AVEC COMPRESSION ---
		document.getElementById('file-input').addEventListener('change', function(e) {
			var file = e.target.files[0];
			if (!file) return;

			// --- CONDITION SPÃ‰CIALE GIF ---
			if (file.type === "image/gif") {
				var reader = new FileReader();
				reader.onload = function(event) {
					var rawImageData = event.target.result;
					// On chiffre directement le GIF sans passer par la compression
					var encryptedImage = CryptoJS.AES.encrypt(rawImageData, SECRET_KEY).toString();
					
					var imageData = {
						id: 'img-' + Date.now(),
						text: "", 
						image: encryptedImage,
						isEncrypted: true,
						time: getNowFormatted(),
						pseudo: myPseudo
					};
					addMessage({ ...imageData, image: rawImageData }, 'me');
					socket.emit('chat message', imageData);
				};
				reader.readAsDataURL(file);
			} 
			// --- POUR TOUT LE RESTE (JPG, PNG) On compresse ---
			else {
				compressImage(file, function(compressedBase64) {
					var encryptedImage = CryptoJS.AES.encrypt(compressedBase64, SECRET_KEY).toString();
					var imageData = {
						id: 'img-' + Date.now(),
						text: "", 
						image: encryptedImage,
						isEncrypted: true,
						time: getNowFormatted(),
						pseudo: myPseudo
					};
					addMessage({ ...imageData, image: compressedBase64 }, 'me');
					socket.emit('chat message', imageData);
				});
			}
			e.target.value = ''; // Reset l'input
		});
    
        // EMOJIS ---
        var picker = new EmojiMart.Picker({
            locale: 'fr',
			native: true, // IMPORTANT : Ã©vite de charger des dossiers d'images externes
            onEmojiSelect: (emoji) => {
                input.value += emoji.native;
                input.dispatchEvent(new Event('input')); 
                input.focus();
                picker.style.display = 'none';
            }
        });
        picker.style.display = 'none';
        picker.style.position = 'absolute';
        picker.style.bottom = '80px';
        picker.style.left = '10px';
        picker.style.zIndex = '1000';
        document.body.appendChild(picker);
    
        document.getElementById('emoji-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            picker.style.display = (picker.style.display === 'none') ? 'block' : 'none';
        });
    
        document.addEventListener('click', (e) => {
            if (!picker.contains(e.target) && e.target.id !== 'emoji-btn') picker.style.display = 'none';
        });
    	
		
    	
    	// DARK MODE ---
    	var themeToggle = document.getElementById('theme-toggle');
    
    	// Charger le thÃ¨me sauvegardÃ©
    	var savedTheme = localStorage.getItem('theme') || 'light';
    	if (savedTheme === 'dark') {
    		document.documentElement.setAttribute('data-theme', 'dark');
    		themeToggle.innerText = 'â˜€ï¸';
    	}
    
    	// Ã‰couter le clic sur le bouton
    	themeToggle.addEventListener('click', () => {
    		var isDark = document.documentElement.hasAttribute('data-theme');
    		if (isDark) {
    			document.documentElement.removeAttribute('data-theme');
    			themeToggle.innerText = 'ðŸŒ™';
    			localStorage.setItem('theme', 'light');
    		} else {
    			document.documentElement.setAttribute('data-theme', 'dark');
    			themeToggle.innerText = 'â˜€ï¸';
    			localStorage.setItem('theme', 'dark');
    		}
    	});
		
		// CHARGEMENT MESSAGE ANCIEN ---
		// Ã‰vÃ©nement clic sur le bouton
		document.getElementById('load-more-btn').addEventListener('click', () => {
			var currentCount = document.querySelectorAll('.message').length;
			socket.emit('load more', currentCount);
		});
		
		// Message vocal
		let mediaRecorder;
		let audioChunks = [];

		var voiceBtn = document.getElementById('voice-btn');
		
		function stopTimer() {
			clearInterval(timerInterval);
		}

		voiceBtn.addEventListener('click', async () => {
			if (!mediaRecorder || mediaRecorder.state === "inactive") {
				// DÃ‰MARRER L'ENREGISTREMENT
				var stream = await navigator.mediaDevices.getUserMedia({ audio: {
					echoCancellation: { ideal: false }, 
					noiseSuppression: { ideal: false }, 
					autoGainControl: { ideal: false },  
					sampleRate: { ideal: 44100 },
					sampleSize: { ideal: 16 },
					channelCount: { ideal: 1 }
					} 
				});
				let mimeType = 'audio/mp4'; // IdÃ©al pour iPhone/Mac et Windows

				if (!MediaRecorder.isTypeSupported(mimeType)) {
					mimeType = 'audio/webm;codecs=opus'; // Repli pour certains navigateurs Linux/Android
				}
				try {
					var recorderOptions = {
						mimeType: mimeType,
						audioBitsPerSecond: 128000
					};
					mediaRecorder = new MediaRecorder(stream, recorderOptions);
					console.log("Recorder initialisÃ© avec le format :", mimeType);
				} catch (e) {
					console.log("Format spÃ©cifique non supportÃ©, utilisation du format par dÃ©faut");
					mediaRecorder = new MediaRecorder(stream);
				}
				audioChunks = [];

				mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);

				mediaRecorder.onstop = async () => {
					stopTimer();
					socket.emit('stop typing');
					var audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
					
					var reader = new FileReader();
					reader.readAsDataURL(audioBlob);
					reader.onloadend = () => {
						var base64Audio = reader.result;
						sendMediaMessage(base64Audio, 'voice'); 
					};
				};

				mediaRecorder.start();
				startTimer();
				socket.emit('typing', myPseudo);
				voiceBtn.textContent = "ðŸ›‘";
				document.getElementById('recording-status').style.display = "inline";
			} else {
				// ARRÃŠTER
				mediaRecorder.stop();
				stopTimer();
				socket.emit('stop typing');
				voiceBtn.textContent = "ðŸŽ¤";
				document.getElementById('recording-status').style.display = "none";
			}
		});
		
		document.addEventListener('touchmove', function (event) {
			if (event.scale !== 1) { event.preventDefault(); }
		}, { passive: false });
		document.addEventListener('touchstart', (event) => {
			if (event.touches.length > 1) {
				event.preventDefault(); // Bloque le zoom Ã  deux doigts
			}
		}, { passive: false });

		document.addEventListener('gesturestart', (event) => {
			event.preventDefault(); // Bloque le geste de zoom spÃ©cifique Ã  Safari
		});
		
		if (window.visualViewport) {
			window.visualViewport.addEventListener('resize', () => {
				const viewHeight = window.visualViewport.height;
				// On force le conteneur Ã  ne pas dÃ©passer la zone visible
				document.getElementById('chat-container').style.height = `${viewHeight}px`;
				// On scrolle tout en haut pour que le header reste calÃ©
				window.scrollTo(0, 0);
			});
		}
		
		// ArrÃªter l'alerte dÃ¨s que l'utilisateur revient sur l'onglet
		document.addEventListener('visibilitychange', () => {
			if (!document.hidden) {
				clearInterval(notificationInterval);
				notificationInterval = null;
				document.title = originalTitle;
			}
		});
    </script>
</body>
</html>