<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script src="translations.js"></script>
	<script src="quotes.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="security.js"></script>
	<script src="ui.js"></script>
	<script src="socket-logic.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">

</head>

<body>
	<div id="welcome-screen">
		<div class="lang-selector-home">
			<select id="lang-select-home" onchange="applyLanguage(this.value)">
				<option value="fr">FranÃ§ais ðŸ‡«ðŸ‡·</option>
				<option value="en">English ðŸ‡¬ðŸ‡§</option>
				<option value="zh">ä¸­æ–‡ ðŸ‡¨ðŸ‡³</option>
			</select>
		</div>

		<div class="welcome-card">
			<h1 id="txt-welcome-title">Bienvenue</h1>
			
			<div id="daily-quote-container">
				<span id="quote-intro" style="font-weight: bold; font-size: 0.9em; color: #3498db;"></span>
				<p id="quote-text">--</p>
			</div>

			<button id="enter-chat-btn" onclick="startSecurityProcess()">AccÃ©der au Chat SÃ©curisÃ©</button>
		</div>
	</div>
    <div id="chat-container">
        <div id="chat-header">
            <div style="font-weight: bold;" id="txt-header-title"></div>

			<div class="clocks-container" style="display: flex; gap: 20px; align-items: center; padding: 10px;">
				<div class="clock-unit">
					<div class="analog-clock" id="them-analog">
						<div class="hand hour"></div>
						<div class="hand minute"></div>
						<div class="center-dot"></div>
					</div>
					<div id="them-city-name" style="margin-top: 4px;">--</div>
				</div>
				<div class="clock-unit">
					<div class="analog-clock" id="me-analog">
						<div class="hand hour"></div>
						<div class="hand minute"></div>
						<div class="center-dot"></div>
					</div>
					<div id="me-city-name" style="margin-top: 4px;">--</div>
				</div>
			</div>
			
            <div class="header-right">
                <a href="/cgu" target="_blank" id="txt-view-cgu"></a>
                <button id="theme-toggle" style="cursor:pointer; border:none; background:none; font-size: 1.2rem;">ðŸŒ™</button>
                <select id="lang-select" style="cursor: pointer; margin-left: 10px;">
                    <option value="fr">FranÃ§ais ðŸ‡«ðŸ‡·</option>
                    <option value="en">English ðŸ‡¬ðŸ‡§</option>
                    <option value="zh">ä¸­æ–‡ ðŸ‡¨ðŸ‡³</option>
                </select>
            </div>
			
        </div>
		<div id="chat-wrapper">
			<button id="load-more-btn" style="width:100%; background:none; border:none; cursor:pointer; display:none;">
				Charger les messages prÃ©cÃ©dents...
			</button>
		</div>
        <ul id="messages"></ul>
        <div id="typing-indicator"></div>
        <form id="form">
            <button type="button" id="emoji-btn">ðŸ˜€</button>
            <label for="file-input" style="cursor:pointer; font-size: 1.5em; padding: 0 10px;">ðŸ“Ž</label>
            <input type="file" id="file-input" accept="image/*" style="display:none;">

            <textarea id="input" placeholder="Ã‰crivez un message..." rows="1"></textarea>
            <button id="send-btn" type="submit">Envoyer</button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        var chatContainer = document.getElementById('chat-container');
        var messages = document.getElementById('messages');
        var form = document.getElementById('form');
        var input = document.getElementById('input');
        var typingIndicator = document.getElementById('typing-indicator');
        var SECRET_KEY = "";
        var myPseudo = "";
        var typingTimeout;        
		
		// Capture les erreurs JavaScript globales
		window.onerror = function(message, source, lineno, colno, error) {
			const errorData = {
				message: message,
				source: source,
				line: lineno,
				pseudo: typeof myPseudo !== 'undefined' ? myPseudo : 'Inconnu'
			};
			// Envoie l'erreur au serveur via le socket
			if (typeof socket !== 'undefined') {
				socket.emit('client error', errorData);
			}
		};
        
    	// Initialisation au chargement
    	document.addEventListener('DOMContentLoaded', () => {
    		const selector = document.getElementById('lang-select');
    		if (selector) {
    			const savedLang = localStorage.getItem('preferred-lang') || 'fr';
    			selector.value = savedLang;
    			applyLanguage(savedLang);
    
    			selector.addEventListener('change', (e) => {
    				applyLanguage(e.target.value);
    			});
    		} else {
    			console.error("Le sÃ©lecteur 'lang-selector' est introuvable !");
    		}
    	});
    
        // FONCTION D'AFFICHAGE DES MESSAGES ---
		function addMessage(data, side, isPrepend = false) {
			var item = document.createElement('li');
			item.classList.add('message', side);
			
			let displayText = "";
			let displayImage = null;

			// --- LOGIQUE DE DÃ‰CHIFFREMENT (Ton code inchangÃ©) ---
			if (data.isEncrypted && SECRET_KEY) {
				try {
					if (data.text && data.text.length > 0) {
						var textBytes = CryptoJS.AES.decrypt(data.text, SECRET_KEY);
						var decryptedText = textBytes.toString(CryptoJS.enc.Utf8);
						displayText = decryptedText || "[Erreur de clÃ©]";
					}
					if (data.image) {
						if (data.image.startsWith('data:image')) {
							displayImage = data.image;
						} else {
							var imgBytes = CryptoJS.AES.decrypt(data.image, SECRET_KEY);
							var decryptedImg = imgBytes.toString(CryptoJS.enc.Utf8);
							displayImage = decryptedImg || null;
							if (!displayImage) displayText = "[ClÃ© image incorrecte]";
						}
					}
				} catch (e) { 
					console.error("Erreur de dÃ©chiffrement :", e);
					displayText = "[Message illisible]"; 
				}
			} else {
				displayText = data.text || "";
				displayImage = data.image || null;
			}

			// --- LOGIQUE D'AFFICHAGE (Ton code inchangÃ©) ---
			var color = getHashColor(data.pseudo || "Anonyme");
			var nameStyle = (side === 'me') ? 'display:none' : `color:${color}; font-weight:bold; font-size:0.8em; margin-bottom:3px;`;
			var imageHtml = displayImage ? `<img src="${displayImage}" style="max-width:100%; border-radius:10px; margin-top:5px; display:block;">` : "";
			var tickContent = (data.read) ? 'âœ“âœ“' : 'âœ“';
			var tickColor = (data.read) ? 'color: #3498db;' : '';
			var statusCheckHtml = (side === 'me') ? `<span class="status-check" id="tick-${data.id || Date.now()}" style="${tickColor}">${tickContent}</span>` : "";

			item.innerHTML = `
				<div style="${nameStyle}">${data.pseudo || 'Anonyme'}</div>
				<div class="message-wrapper">
					<div>${displayText}</div>
					${imageHtml}
				</div>
				<div class="message-footer" style="display: flex; align-items: center; justify-content: flex-end; gap: 4px;">
					<span class="time">${data.time || ''}</span>
					${statusCheckHtml}
				</div>
			`;

			// --- LOGIQUE D'INSERTION (C'est ici que Ã§a change) ---
			const messagesList = document.getElementById('messages');

			if (isPrepend) {
				// On insÃ¨re tout en haut de la liste <ul>
				messagesList.prepend(item); 
			} else {
				// On ajoute en bas normalement
				messagesList.appendChild(item);
				messagesList.scrollTop = messagesList.scrollHeight;
			}
		}
    
        // ENVOI DE TEXTE ---
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          if (input.value.trim()) {
            var timeStr = getNowFormatted(); // Utilisation du nouveau format
            
            var encryptedText = CryptoJS.AES.encrypt(input.value, SECRET_KEY).toString();
            var data = { text: encryptedText, time: timeStr, pseudo: myPseudo, isEncrypted: true, id: 'msg-' + Date.now() };
            
            addMessage(data, 'me');
            socket.emit('chat message', data);
            input.value = '';
            input.style.height = 'auto';
            socket.emit('stop typing');
          }
        });
    
        // IHM : ENTRÃ‰E ET AGRANDISSEMENT AUTO ---
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            form.dispatchEvent(new Event('submit'));
          }
        });
    
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            socket.emit('typing', myPseudo);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => socket.emit('stop typing'), 5000);
        });
    
        // ENVOI DE PHOTOS CHIFFRÃ‰ES AVEC COMPRESSION ---
		document.getElementById('file-input').addEventListener('change', function(e) {
			const file = e.target.files[0];
			if (!file) return;

			// --- CONDITION SPÃ‰CIALE GIF ---
			if (file.type === "image/gif") {
				const reader = new FileReader();
				reader.onload = function(event) {
					const rawImageData = event.target.result;
					// On chiffre directement le GIF sans passer par la compression
					const encryptedImage = CryptoJS.AES.encrypt(rawImageData, SECRET_KEY).toString();
					
					const imageData = {
						id: 'img-' + Date.now(),
						text: "", 
						image: encryptedImage,
						isEncrypted: true,
						time: getNowFormatted(),
						pseudo: myPseudo
					};
					addMessage({ ...imageData, image: rawImageData }, 'me');
					socket.emit('chat message', imageData);
				};
				reader.readAsDataURL(file);
			} 
			// --- POUR TOUT LE RESTE (JPG, PNG) On compresse ---
			else {
				compressImage(file, function(compressedBase64) {
					const encryptedImage = CryptoJS.AES.encrypt(compressedBase64, SECRET_KEY).toString();
					const imageData = {
						id: 'img-' + Date.now(),
						text: "", 
						image: encryptedImage,
						isEncrypted: true,
						time: getNowFormatted(),
						pseudo: myPseudo
					};
					addMessage({ ...imageData, image: compressedBase64 }, 'me');
					socket.emit('chat message', imageData);
				});
			}
			e.target.value = ''; // Reset l'input
		});
    
        // EMOJIS ---
        const picker = new EmojiMart.Picker({
            locale: 'fr',
            onEmojiSelect: (emoji) => {
                input.value += emoji.native;
                input.dispatchEvent(new Event('input')); 
                input.focus();
                picker.style.display = 'none';
            }
        });
        picker.style.display = 'none';
        picker.style.position = 'absolute';
        picker.style.bottom = '80px';
        picker.style.left = '10px';
        picker.style.zIndex = '1000';
        document.body.appendChild(picker);
    
        document.getElementById('emoji-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            picker.style.display = (picker.style.display === 'none') ? 'block' : 'none';
        });
    
        document.addEventListener('click', (e) => {
            if (!picker.contains(e.target) && e.target.id !== 'emoji-btn') picker.style.display = 'none';
        });
    	
		
    	
    	// DARK MODE ---
    	const themeToggle = document.getElementById('theme-toggle');
    
    	// Charger le thÃ¨me sauvegardÃ©
    	const savedTheme = localStorage.getItem('theme') || 'light';
    	if (savedTheme === 'dark') {
    		document.documentElement.setAttribute('data-theme', 'dark');
    		themeToggle.innerText = 'â˜€ï¸';
    	}
    
    	// Ã‰couter le clic sur le bouton
    	themeToggle.addEventListener('click', () => {
    		const isDark = document.documentElement.hasAttribute('data-theme');
    		if (isDark) {
    			document.documentElement.removeAttribute('data-theme');
    			themeToggle.innerText = 'ðŸŒ™';
    			localStorage.setItem('theme', 'light');
    		} else {
    			document.documentElement.setAttribute('data-theme', 'dark');
    			themeToggle.innerText = 'â˜€ï¸';
    			localStorage.setItem('theme', 'dark');
    		}
    	});
		
		// CHARGEMENT MESSAGE ANCIEN ---
		// Ã‰vÃ©nement clic sur le bouton
		document.getElementById('load-more-btn').addEventListener('click', () => {
			const currentCount = document.querySelectorAll('.message').length;
			socket.emit('load more', currentCount);
		});
		
    </script>
</body>
</html>